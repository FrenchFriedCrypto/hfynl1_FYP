<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Pool Minter</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>
  <style>
    /* Navbar */
    .navbar {
      background: #f9f9f9;
      padding: 0.5em 1em;
      display: flex;
      gap: 0.5em;
      border-bottom: 1px solid #ddd;
    }
    .nav-button {
      background: #fff;
      color: #333;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 0.5em 1em;
      cursor: pointer;
      font-size: 1em;
    }
    .nav-button:hover { background: #f0f0f0; }

    /* Table */
    table { border-collapse: collapse; width: 100%; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; }
    th { background: #f4f4f4; }
    button { padding: 0.3em 0.6em; }
  </style>
</head>
<body>
<div class="navbar">
  <button class="nav-button" onclick="window.location.href='index.html'">Mint LP Pools</button>
  <button class="nav-button" onclick="window.location.href='interact.html'">Interact / Swap</button>
</div>

<h1>Mint New Pools</h1>
<div style="margin-bottom:1em;">
  <label for="multiCount">Number of tokens for Multi LP Pool (1‚Äì5):</label>
  <input type="number" id="multiCount" min="1" max="5" value="3" />
</div>
<button id="dualBtn">Mint Dual LP Pool & Add Liquidity</button>
<button id="multiBtn">Mint Multi‚ÄëToken LP Pool & Add Liquidity</button>
<p id="status"></p>

<div style="margin: 1em 0;">
  <button id="removeAllBtn">Remove All Pools</button>
</div>

<h2>Deployed Pools</h2>
<table id="poolsTable">
  <thead>
  <tr><th>Type</th><th>Address</th><th>Tokens</th><th>Actions</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  let account;


  // --- Table helpers ---
  function addPoolToTable(type, address, tokens) {
    const tbody = document.querySelector('#poolsTable tbody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td>${type}</td>
        <td><code>${address}</code></td>
        <td>${tokens.join(', ')}</td>
        <td>
          <button onclick="window.location.href='interact.html?type=${type}&address=${address}'">
            Interact
          </button>
          <button onclick="removePool('${type}', '${address}', this)">
            Remove
          </button>
        </td>
      `;
    tbody.appendChild(tr);
  }

  function removePool(type, address, btn) {
    // Remove from storage
    const key = `${type.toLowerCase()}Pool_${address}`;
    localStorage.removeItem(key);
    // Remove row from table
    btn.closest('tr').remove();
  }

  function removeAllPools() {
    // Clear all pool entries from localStorage
    Object.keys(localStorage).forEach(key => {
      if (key.startsWith('dualPool_') || key.startsWith('multiPool_')) {
        localStorage.removeItem(key);
      }
    });
    // Clear table body
    document.querySelector('#poolsTable tbody').innerHTML = '';
  }

  function loadPoolsFromStorage() {
    Object.keys(localStorage).forEach(key => {
      if (key.startsWith('dualPool_') || key.startsWith('multiPool_')) {
        const data = JSON.parse(localStorage.getItem(key));
        const address = key.split('_')[1];
        const type = key.startsWith('dualPool_') ? 'Dual' : 'Multi';
        const tokens = type === 'Dual' ? [data.tokenA, data.tokenB] : data.tokens;
        addPoolToTable(type, address, tokens);
      }
    });
  }

  window.addEventListener('load', async () => {
    // 1) load table & wire up Remove All
    loadPoolsFromStorage();
    document.getElementById('removeAllBtn').onclick = removeAllPools;

    // 2) initialize web3 & fetch account
    if (window.ethereum) {
      window.web3 = new Web3(window.ethereum);
      await window.ethereum.request({ method: 'eth_requestAccounts' });
    } else {
      window.web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
    }
    const accts = await web3.eth.getAccounts();
    account = accts[0];

    // 3) now that account is set, wire up your deploy buttons:
    // --- DualPool flow ---
    document.getElementById("dualBtn").onclick = async () => {
      if (!account) { status.innerText = "Waiting for account‚Ä¶"; return; }
      const feeOpts = {
        from: account,
        maxPriorityFeePerGas: web3.utils.toWei('1','gwei'),
        maxFeePerGas:        web3.utils.toWei('2','gwei')
      };
      status.innerText = "Deploying DualPool‚Ä¶";
      const [t0, t1] = predefinedTokens;
      const amt0 = web3.utils.toWei('1500','ether'), amt1 = web3.utils.toWei('1500','ether');

      // 1) deploy
      const ctr = new web3.eth.Contract(dualAbi);
      const receipt = await ctr.deploy({ data: dualBytecode, arguments: [t0,t1] })
              .send({ from: account });
      const poolAddr = receipt.options.address;
      const pool    = new web3.eth.Contract(dualAbi, poolAddr);

      // 2) approve token0
      status.innerText = "Approving token0‚Ä¶";
      await new web3.eth.Contract(erc20Abi, t0).methods
              .approve(poolAddr, amt0).send(feeOpts);
      await debugToken(t0, poolAddr);

      // 3) approve token1
      status.innerText = "Approving token1‚Ä¶";
      await new web3.eth.Contract(erc20Abi, t1).methods
              .approve(poolAddr, amt1).send(feeOpts);
      await debugToken(t1, poolAddr);

      // 4) dry‚Äërun addLiquidity
      status.innerText = "Checking addLiquidity‚Ä¶";
      try {
        await pool.methods.addLiquidity(amt0, amt1).call({ from: account });
      } catch (err) {
        status.innerText = `addLiquidity would revert: ${err.reason||err.message}`;
        return;
      }

      // 5) send addLiquidity
      status.innerText = "Adding liquidity‚Ä¶";
      await pool.methods.addLiquidity(amt0, amt1).send(feeOpts);

      status.innerText = `DualPool deployed & funded at ${poolAddr} üéâ`;
      localStorage.setItem(`dualPool_${poolAddr}`, JSON.stringify({ tokenA:t0, tokenB:t1 }));
      addPoolToTable('Dual', poolAddr, [t0,t1]);
    };


    // --- MultiPool flow ---
    document.getElementById("multiBtn").onclick = async () => {
      if (!account) {
        status.innerText = "Waiting for account‚Ä¶";
        return;
      }

      // 1) Prepare tokens & amounts
      const count   = Math.min(5, Math.max(1, +document.getElementById("multiCount").value));
      const tokens  = predefinedTokens.slice(0, count);
      const amt     = web3.utils.toWei('1000', 'ether');
      const amounts = tokens.map(() => amt);

      // 2) Common tx options
      const txOpts = {
        from: account,
        maxPriorityFeePerGas: web3.utils.toWei('1', 'gwei'),
        maxFeePerGas:        web3.utils.toWei('2', 'gwei')
      };

      // 3) Deploy **only** with tokens
      status.innerText = "Deploying MultiPool‚Ä¶";
      const deployedContract = await new web3.eth.Contract(multiAbi)
              .deploy({
                data:      multiBytecode,
                arguments: [tokens]         // ‚Üê just the tokens array
              })
              .send({
                ...txOpts,
                gas: await web3.eth.estimateGas({
                  from: account,
                  data: multiBytecode +
                          web3.eth.abi.encodeParameters([ "address[]" ], [tokens]).slice(2)
                }) + 50_000
              });

      // 4) Grab the address from the Contract instance
      const poolAddr = deployedContract.options.address;
      if (!poolAddr) {
        throw new Error("No pool address‚Äîsomething went wrong in deploy()");
      }
      const pool = new web3.eth.Contract(multiAbi, poolAddr);

      // 5) Approve each token to the pool
      for (let t of tokens) {
        status.innerText = `Approving ${t}‚Ä¶`;
        await new web3.eth.Contract(erc20Abi, t).methods
                .approve(poolAddr, amt)
                .send({ ...txOpts, gas: 100_000 });
        await debugToken(t, poolAddr);
      }

      // 6) Seed via addLiquidity
      status.innerText = "Adding liquidity‚Ä¶";
      await pool.methods
              .addLiquidity(amounts)
              .send({ ...txOpts, gas: 900_000 });

      // 7) Done!
      status.innerText = `MultiPool deployed & funded at ${poolAddr} üéâ`;
      localStorage.setItem(`multiPool_${poolAddr}`, JSON.stringify({ tokens, amounts }));
      addPoolToTable('Multi', poolAddr, tokens);
    };

  });

  // --- ABIs & bytecodes (your compiled contracts) ---
  const dualAbi      = [{"type":"constructor","inputs":[{"name":"_token0","type":"address","internalType":"address"},{"name":"_token1","type":"address","internalType":"address"}],"stateMutability":"nonpayable"},{"type":"function","name":"addLiquidity","inputs":[{"name":"amount0","type":"uint256","internalType":"uint256"},{"name":"amount1","type":"uint256","internalType":"uint256"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"getReserves","inputs":[],"outputs":[{"name":"","type":"uint112","internalType":"uint112"},{"name":"","type":"uint112","internalType":"uint112"}],"stateMutability":"view"},{"type":"function","name":"swap","inputs":[{"name":"tokenIn","type":"address","internalType":"address"},{"name":"amountIn","type":"uint256","internalType":"uint256"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"token0","inputs":[],"outputs":[{"name":"","type":"address","internalType":"contract IERC20"}],"stateMutability":"view"},{"type":"function","name":"token1","inputs":[],"outputs":[{"name":"","type":"address","internalType":"contract IERC20"}],"stateMutability":"view"},{"type":"event","name":"LiquidityAdded","inputs":[{"name":"provider","type":"address","indexed":true,"internalType":"address"},{"name":"amount0","type":"uint256","indexed":false,"internalType":"uint256"},{"name":"amount1","type":"uint256","indexed":false,"internalType":"uint256"},{"name":"newReserve0","type":"uint112","indexed":false,"internalType":"uint112"},{"name":"newReserve1","type":"uint112","indexed":false,"internalType":"uint112"}],"anonymous":false},{"type":"event","name":"Swapped","inputs":[{"name":"buyer","type":"address","indexed":true,"internalType":"address"},{"name":"tokenIn","type":"address","indexed":true,"internalType":"address"},{"name":"amountIn","type":"uint256","indexed":false,"internalType":"uint256"},{"name":"tokenOut","type":"address","indexed":true,"internalType":"address"},{"name":"amountOut","type":"uint256","indexed":false,"internalType":"uint256"}],"anonymous":false}];
  const dualBytecode = "0x608060405234801561000f575f5ffd5b506040516111f53803806111f583398181016040528101906100319190610183565b8073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff160361009f576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016100969061021b565b60405180910390fd5b815f5f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508060015f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505050610239565b5f5ffd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f61015282610129565b9050919050565b61016281610148565b811461016c575f5ffd5b50565b5f8151905061017d81610159565b92915050565b5f5f6040838503121561019957610198610125565b5b5f6101a68582860161016f565b92505060206101b78582860161016f565b9150509250929050565b5f82825260208201905092915050565b7f546f6b656e73206d7573742064696666657200000000000000000000000000005f82015250565b5f6102056012836101c1565b9150610210826101d1565b602082019050919050565b5f6020820190508181035f830152610232816101f9565b9050919050565b610faf806102465f395ff3fe608060405234801561000f575f5ffd5b5060043610610055575f3560e01c80630902f1ac146100595780630dfe1681146100785780639cd441da14610096578063d004f0f7146100b2578063d21220a7146100ce575b5f5ffd5b6100616100ec565b60405161006f929190610a3b565b60405180910390f35b61008061012f565b60405161008d9190610adc565b60405180910390f35b6100b060048036038101906100ab9190610b2c565b610153565b005b6100cc60048036038101906100c79190610ba5565b6103d8565b005b6100d66109ee565b6040516100e39190610adc565b60405180910390f35b5f5f60025f9054906101000a90046dffffffffffffffffffffffffffff166002600e9054906101000a90046dffffffffffffffffffffffffffff16915091509091565b5f5f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b5f5f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166323b872dd3330856040518463ffffffff1660e01b81526004016101b093929190610c01565b6020604051808303815f875af11580156101cc573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906101f09190610c6b565b5060015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166323b872dd3330846040518463ffffffff1660e01b815260040161024f93929190610c01565b6020604051808303815f875af115801561026b573d5f5f3e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061028f9190610c6b565b508160025f8282829054906101000a90046dffffffffffffffffffffffffffff166102ba9190610cc3565b92506101000a8154816dffffffffffffffffffffffffffff02191690836dffffffffffffffffffffffffffff160217905550806002600e8282829054906101000a90046dffffffffffffffffffffffffffff166103179190610cc3565b92506101000a8154816dffffffffffffffffffffffffffff02191690836dffffffffffffffffffffffffffff1602179055503373ffffffffffffffffffffffffffffffffffffffff167fe63a52accf003073a541a89f745ca54b20129c76a7f875a3f98f987cb5a91f4a838360025f9054906101000a90046dffffffffffffffffffffffffffff166002600e9054906101000a90046dffffffffffffffffffffffffffff166040516103cc9493929190610d04565b60405180910390a25050565b5f5f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16148061047e575060015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16145b6104bd576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104b490610da1565b60405180910390fd5b5f5f5f5f5f5f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168673ffffffffffffffffffffffffffffffffffffffff16146105955760015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff165f5f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff166002600e9054906101000a90046dffffffffffffffffffffffffffff1660025f9054906101000a90046dffffffffffffffffffffffffffff16610612565b5f5f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1660015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1660025f9054906101000a90046dffffffffffffffffffffffffffff166002600e9054906101000a90046dffffffffffffffffffffffffffff165b93509350935093505f816dffffffffffffffffffffffffffff16836dffffffffffffffffffffffffffff166106479190610dbf565b90505f86846dffffffffffffffffffffffffffff166106669190610e00565b90505f81836106759190610e60565b846dffffffffffffffffffffffffffff166106909190610e90565b90505f81116106d4576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016106cb90610f0d565b60405180910390fd5b8673ffffffffffffffffffffffffffffffffffffffff166323b872dd33308b6040518463ffffffff1660e01b815260040161071193929190610c01565b6020604051808303815f875af115801561072d573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906107519190610c6b565b508573ffffffffffffffffffffffffffffffffffffffff1663a9059cbb33836040518363ffffffff1660e01b815260040161078d929190610f2b565b6020604051808303815f875af11580156107a9573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906107cd9190610c6b565b505f5f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168973ffffffffffffffffffffffffffffffffffffffff16036108c55787856dffffffffffffffffffffffffffff1661083d9190610e00565b60025f6101000a8154816dffffffffffffffffffffffffffff02191690836dffffffffffffffffffffffffffff16021790555080846dffffffffffffffffffffffffffff1661088c9190610e90565b6002600e6101000a8154816dffffffffffffffffffffffffffff02191690836dffffffffffffffffffffffffffff160217905550610965565b87856dffffffffffffffffffffffffffff166108e19190610e00565b6002600e6101000a8154816dffffffffffffffffffffffffffff02191690836dffffffffffffffffffffffffffff16021790555080846dffffffffffffffffffffffffffff166109319190610e90565b60025f6101000a8154816dffffffffffffffffffffffffffff02191690836dffffffffffffffffffffffffffff1602179055505b8573ffffffffffffffffffffffffffffffffffffffff168973ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f692315744755ee6d80decaeb993d4b1bb95ff5db042cc47b32d5a7d858b019028b856040516109db929190610f52565b60405180910390a4505050505050505050565b60015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b5f6dffffffffffffffffffffffffffff82169050919050565b610a3581610a13565b82525050565b5f604082019050610a4e5f830185610a2c565b610a5b6020830184610a2c565b9392505050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f819050919050565b5f610aa4610a9f610a9a84610a62565b610a81565b610a62565b9050919050565b5f610ab582610a8a565b9050919050565b5f610ac682610aab565b9050919050565b610ad681610abc565b82525050565b5f602082019050610aef5f830184610acd565b92915050565b5f5ffd5b5f819050919050565b610b0b81610af9565b8114610b15575f5ffd5b50565b5f81359050610b2681610b02565b92915050565b5f5f60408385031215610b4257610b41610af5565b5b5f610b4f85828601610b18565b9250506020610b6085828601610b18565b9150509250929050565b5f610b7482610a62565b9050919050565b610b8481610b6a565b8114610b8e575f5ffd5b50565b5f81359050610b9f81610b7b565b92915050565b5f5f60408385031215610bbb57610bba610af5565b5b5f610bc885828601610b91565b9250506020610bd985828601610b18565b9150509250929050565b610bec81610b6a565b82525050565b610bfb81610af9565b82525050565b5f606082019050610c145f830186610be3565b610c216020830185610be3565b610c2e6040830184610bf2565b949350505050565b5f8115159050919050565b610c4a81610c36565b8114610c54575f5ffd5b50565b5f81519050610c6581610c41565b92915050565b5f60208284031215610c8057610c7f610af5565b5b5f610c8d84828501610c57565b91505092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f610ccd82610a13565b9150610cd883610a13565b925082820190506dffffffffffffffffffffffffffff811115610cfe57610cfd610c96565b5b92915050565b5f608082019050610d175f830187610bf2565b610d246020830186610bf2565b610d316040830185610a2c565b610d3e6060830184610a2c565b95945050505050565b5f82825260208201905092915050565b7f496e76616c696420746f6b656e496e00000000000000000000000000000000005f82015250565b5f610d8b600f83610d47565b9150610d9682610d57565b602082019050919050565b5f6020820190508181035f830152610db881610d7f565b9050919050565b5f610dc982610af9565b9150610dd483610af9565b9250828202610de281610af9565b91508282048414831517610df957610df8610c96565b5b5092915050565b5f610e0a82610af9565b9150610e1583610af9565b9250828201905080821115610e2d57610e2c610c96565b5b92915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601260045260245ffd5b5f610e6a82610af9565b9150610e7583610af9565b925082610e8557610e84610e33565b5b828204905092915050565b5f610e9a82610af9565b9150610ea583610af9565b9250828203905081811115610ebd57610ebc610c96565b5b92915050565b7f496e73756666696369656e74206f7574707574000000000000000000000000005f82015250565b5f610ef7601383610d47565b9150610f0282610ec3565b602082019050919050565b5f6020820190508181035f830152610f2481610eeb565b9050919050565b5f604082019050610f3e5f830185610be3565b610f4b6020830184610bf2565b9392505050565b5f604082019050610f655f830185610bf2565b610f726020830184610bf2565b939250505056fea26469706673582212205b4842e864f10e918b3806ad14a74512b60c30e74664921e2bcac3f10b91688264736f6c634300081c0033";   // from out/DualPool.sol/DualPool.json

  const multiAbi      = [{"type":"constructor","inputs":[{"name":"_tokens","type":"address[]","internalType":"address[]"}],"stateMutability":"nonpayable"},{"type":"function","name":"addLiquidity","inputs":[{"name":"amounts","type":"uint256[]","internalType":"uint256[]"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"getAllReserves","inputs":[],"outputs":[{"name":"","type":"uint256[]","internalType":"uint256[]"}],"stateMutability":"view"},{"type":"function","name":"reserves","inputs":[{"name":"","type":"address","internalType":"address"}],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"swap","inputs":[{"name":"tokenIn","type":"address","internalType":"address"},{"name":"amountIn","type":"uint256","internalType":"uint256"},{"name":"tokenOut","type":"address","internalType":"address"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"tokens","inputs":[{"name":"","type":"uint256","internalType":"uint256"}],"outputs":[{"name":"","type":"address","internalType":"address"}],"stateMutability":"view"},{"type":"event","name":"LiquidityAdded","inputs":[{"name":"provider","type":"address","indexed":true,"internalType":"address"},{"name":"tokens","type":"address[]","indexed":false,"internalType":"address[]"},{"name":"amounts","type":"uint256[]","indexed":false,"internalType":"uint256[]"}],"anonymous":false},{"type":"event","name":"Swapped","inputs":[{"name":"buyer","type":"address","indexed":true,"internalType":"address"},{"name":"tokenIn","type":"address","indexed":true,"internalType":"address"},{"name":"amountIn","type":"uint256","indexed":false,"internalType":"uint256"},{"name":"tokenOut","type":"address","indexed":true,"internalType":"address"},{"name":"amountOut","type":"uint256","indexed":false,"internalType":"uint256"}],"anonymous":false}];
  const multiBytecode = "0x608060405234801561000f575f5ffd5b506040516118a33803806118a38339818101604052810190610031919061038a565b600281511015610076576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161006d9061042b565b60405180910390fd5b805f908051906020019061008b92919061012d565b505f5f90505b5f80549050811015610126575f60015f5f84815481106100b4576100b3610449565b5b905f5260205f20015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20819055508080600101915050610091565b5050610476565b828054828255905f5260205f209081019282156101a3579160200282015b828111156101a2578251825f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055509160200191906001019061014b565b5b5090506101b091906101b4565b5090565b5b808211156101cb575f815f9055506001016101b5565b5090565b5f604051905090565b5f5ffd5b5f5ffd5b5f5ffd5b5f601f19601f8301169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b61022a826101e4565b810181811067ffffffffffffffff82111715610249576102486101f4565b5b80604052505050565b5f61025b6101cf565b90506102678282610221565b919050565b5f67ffffffffffffffff821115610286576102856101f4565b5b602082029050602081019050919050565b5f5ffd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6102c48261029b565b9050919050565b6102d4816102ba565b81146102de575f5ffd5b50565b5f815190506102ef816102cb565b92915050565b5f6103076103028461026c565b610252565b9050808382526020820190506020840283018581111561032a57610329610297565b5b835b81811015610353578061033f88826102e1565b84526020840193505060208101905061032c565b5050509392505050565b5f82601f830112610371576103706101e0565b5b81516103818482602086016102f5565b91505092915050565b5f6020828403121561039f5761039e6101d8565b5b5f82015167ffffffffffffffff8111156103bc576103bb6101dc565b5b6103c88482850161035d565b91505092915050565b5f82825260208201905092915050565b7f4e656564203e3d3220746f6b656e7300000000000000000000000000000000005f82015250565b5f610415600f836103d1565b9150610420826103e1565b602082019050919050565b5f6020820190508181035f83015261044281610409565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603260045260245ffd5b611420806104835f395ff3fe608060405234801561000f575f5ffd5b5060043610610055575f3560e01c80634de59aa3146100595780634f64b2be146100755780636aa701bf146100a55780636d069a67146100c3578063d66bd524146100df575b5f5ffd5b610073600480360381019061006e9190610b70565b61010f565b005b61008f600480360381019061008a9190610bb7565b610335565b60405161009c9190610c21565b60405180910390f35b6100ad61036f565b6040516100ba9190610cf1565b60405180910390f35b6100dd60048036038101906100d89190610d3b565b61047e565b005b6100f960048036038101906100f49190610d8b565b6109c7565b6040516101069190610dc5565b60405180910390f35b5f80549050815114610156576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161014d90610e38565b60405180910390fd5b5f5f90505b5f805490508110156102e1575f5f828154811061017b5761017a610e56565b5b905f5260205f20015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690505f8383815181106101b9576101b8610e56565b5b602002602001015190508173ffffffffffffffffffffffffffffffffffffffff166323b872dd3330846040518463ffffffff1660e01b815260040161020093929190610e83565b6020604051808303815f875af115801561021c573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906102409190610eed565b61027f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161027690610f62565b60405180910390fd5b8060015f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8282546102cb9190610fad565b925050819055505050808060010191505061015b565b503373ffffffffffffffffffffffffffffffffffffffff167fac353be5e91ce7aea4b3c327a183f5c5f3867d7f4dfbbb8b5980b4e603bf6d975f8360405161032a9291906110f6565b60405180910390a250565b5f8181548110610343575f80fd5b905f5260205f20015f915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60605f5f8054905067ffffffffffffffff8111156103905761038f610a01565b5b6040519080825280602002602001820160405280156103be5781602001602082028036833780820191505090505b5090505f5f90505b5f805490508110156104765760015f5f83815481106103e8576103e7610e56565b5b905f5260205f20015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205482828151811061045d5761045c610e56565b5b60200260200101818152505080806001019150506103c6565b508091505090565b5f60015f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205411801561050657505f60015f8373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2054115b610545576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161053c90611175565b60405180910390fd5b5f600190505f5f90505b5f805490508110156105ed5760015f5f838154811061057157610570610e56565b5b905f5260205f20015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2054826105de9190611193565b9150808060010191505061054f565b505f8360015f8773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20546106389190610fad565b90505f60015f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2054836106849190611201565b90505f82826106939190611201565b90505f8160015f8873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20546106df9190611231565b90505f8111610723576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161071a906112ae565b60405180910390fd5b8773ffffffffffffffffffffffffffffffffffffffff166323b872dd33308a6040518463ffffffff1660e01b815260040161076093929190610e83565b6020604051808303815f875af115801561077c573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906107a09190610eed565b6107df576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016107d690611316565b60405180910390fd5b8573ffffffffffffffffffffffffffffffffffffffff1663a9059cbb33836040518363ffffffff1660e01b815260040161081a929190611334565b6020604051808303815f875af1158015610836573d5f5f3e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061085a9190610eed565b610899576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610890906113a5565b60405180910390fd5b8660015f8a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8282546108e59190610fad565b925050819055508060015f8873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8282546109389190611231565b925050819055508573ffffffffffffffffffffffffffffffffffffffff168873ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f692315744755ee6d80decaeb993d4b1bb95ff5db042cc47b32d5a7d858b019028a856040516109b59291906113c3565b60405180910390a45050505050505050565b6001602052805f5260405f205f915090505481565b5f604051905090565b5f5ffd5b5f5ffd5b5f5ffd5b5f601f19601f8301169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b610a37826109f1565b810181811067ffffffffffffffff82111715610a5657610a55610a01565b5b80604052505050565b5f610a686109dc565b9050610a748282610a2e565b919050565b5f67ffffffffffffffff821115610a9357610a92610a01565b5b602082029050602081019050919050565b5f5ffd5b5f819050919050565b610aba81610aa8565b8114610ac4575f5ffd5b50565b5f81359050610ad581610ab1565b92915050565b5f610aed610ae884610a79565b610a5f565b90508083825260208201905060208402830185811115610b1057610b0f610aa4565b5b835b81811015610b395780610b258882610ac7565b845260208401935050602081019050610b12565b5050509392505050565b5f82601f830112610b5757610b566109ed565b5b8135610b67848260208601610adb565b91505092915050565b5f60208284031215610b8557610b846109e5565b5b5f82013567ffffffffffffffff811115610ba257610ba16109e9565b5b610bae84828501610b43565b91505092915050565b5f60208284031215610bcc57610bcb6109e5565b5b5f610bd984828501610ac7565b91505092915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f610c0b82610be2565b9050919050565b610c1b81610c01565b82525050565b5f602082019050610c345f830184610c12565b92915050565b5f81519050919050565b5f82825260208201905092915050565b5f819050602082019050919050565b610c6c81610aa8565b82525050565b5f610c7d8383610c63565b60208301905092915050565b5f602082019050919050565b5f610c9f82610c3a565b610ca98185610c44565b9350610cb483610c54565b805f5b83811015610ce4578151610ccb8882610c72565b9750610cd683610c89565b925050600181019050610cb7565b5085935050505092915050565b5f6020820190508181035f830152610d098184610c95565b905092915050565b610d1a81610c01565b8114610d24575f5ffd5b50565b5f81359050610d3581610d11565b92915050565b5f5f5f60608486031215610d5257610d516109e5565b5b5f610d5f86828701610d27565b9350506020610d7086828701610ac7565b9250506040610d8186828701610d27565b9150509250925092565b5f60208284031215610da057610d9f6109e5565b5b5f610dad84828501610d27565b91505092915050565b610dbf81610aa8565b82525050565b5f602082019050610dd85f830184610db6565b92915050565b5f82825260208201905092915050565b7f426164206172726179206c656e677468000000000000000000000000000000005f82015250565b5f610e22601083610dde565b9150610e2d82610dee565b602082019050919050565b5f6020820190508181035f830152610e4f81610e16565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603260045260245ffd5b5f606082019050610e965f830186610c12565b610ea36020830185610c12565b610eb06040830184610db6565b949350505050565b5f8115159050919050565b610ecc81610eb8565b8114610ed6575f5ffd5b50565b5f81519050610ee781610ec3565b92915050565b5f60208284031215610f0257610f016109e5565b5b5f610f0f84828501610ed9565b91505092915050565b7f54460000000000000000000000000000000000000000000000000000000000005f82015250565b5f610f4c600283610dde565b9150610f5782610f18565b602082019050919050565b5f6020820190508181035f830152610f7981610f40565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f610fb782610aa8565b9150610fc283610aa8565b9250828201905080821115610fda57610fd9610f80565b5b92915050565b5f81549050919050565b5f82825260208201905092915050565b5f819050815f5260205f209050919050565b61101581610c01565b82525050565b5f611026838361100c565b60208301905092915050565b5f815f1c9050919050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f61106e61106983611032565b61103d565b9050919050565b5f611080825461105c565b9050919050565b5f600182019050919050565b5f61109d82610fe0565b6110a78185610fea565b93506110b283610ffa565b805f5b838110156110e9576110c682611075565b6110d0888261101b565b97506110db83611087565b9250506001810190506110b5565b5085935050505092915050565b5f6040820190508181035f83015261110e8185611093565b905081810360208301526111228184610c95565b90509392505050565b7f496e76616c696420746f6b656e730000000000000000000000000000000000005f82015250565b5f61115f600e83610dde565b915061116a8261112b565b602082019050919050565b5f6020820190508181035f83015261118c81611153565b9050919050565b5f61119d82610aa8565b91506111a883610aa8565b92508282026111b681610aa8565b915082820484148315176111cd576111cc610f80565b5b5092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601260045260245ffd5b5f61120b82610aa8565b915061121683610aa8565b925082611226576112256111d4565b5b828204905092915050565b5f61123b82610aa8565b915061124683610aa8565b925082820390508181111561125e5761125d610f80565b5b92915050565b7f496e73756666696369656e74206f7574707574000000000000000000000000005f82015250565b5f611298601383610dde565b91506112a382611264565b602082019050919050565b5f6020820190508181035f8301526112c58161128c565b9050919050565b7f544620696e0000000000000000000000000000000000000000000000000000005f82015250565b5f611300600583610dde565b915061130b826112cc565b602082019050919050565b5f6020820190508181035f83015261132d816112f4565b9050919050565b5f6040820190506113475f830185610c12565b6113546020830184610db6565b9392505050565b7f5446206f757400000000000000000000000000000000000000000000000000005f82015250565b5f61138f600683610dde565b915061139a8261135b565b602082019050919050565b5f6020820190508181035f8301526113bc81611383565b9050919050565b5f6040820190506113d65f830185610db6565b6113e36020830184610db6565b939250505056fea26469706673582212202477a9f41c34397fc6d6a7a9947863a3aec43d1ddc14a1aadadfbf53db25f0f164736f6c634300081c0033";   // from out/MultiPool.sol/MultiPool.json


  // Minimal ERC20 ABI + debug
  const erc20Abi = [{ constant:false, inputs:[{name:"_spender",type:"address"},{name:"_value",type:"uint256"}], name:"approve", outputs:[{name:"",type:"bool"}], type:"function" }];
  const infoAbi = [
    { constant:true, inputs:[{name:"",type:"address"}], name:"balanceOf", outputs:[{name:"",type:"uint256"}], type:"function" },
    { constant:true, inputs:[{name:"",type:"address"},{name:"",type:"address"}], name:"allowance", outputs:[{name:"",type:"uint256"}], type:"function" }
  ];
  const predefinedTokens = [
    "0x18E317A7D70d8fBf8e6E893616b52390EbBdb629",
    "0x4b6aB5F819A515382B0dEB6935D793817bB4af28",
    "0xCace1b78160AE76398F486c8a18044da0d66d86D",
    "0xD5ac451B0c50B9476107823Af206eD814a2e2580",
    "0xF8e31cb472bc70500f08Cd84917E5A1912Ec8397",
    "0xc0F115A19107322cFBf1cDBC7ea011C19EbDB4F8"
  ];
  async function debugToken(token, poolAddr) {
    const c = new web3.eth.Contract(infoAbi, token);
    const bal  = await c.methods.balanceOf(account).call();
    const allo = await c.methods.allowance(account, poolAddr).call();
    console.log(`‚Üí ${token} | balance: ${web3.utils.fromWei(bal)} | allowance: ${web3.utils.fromWei(allo)}`);
  }

  const status = document.getElementById("status");



  // --- MultiPool flow ---










</script>
</body>
</html>
